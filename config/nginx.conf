# /etc/nginx/nginx.conf

user nginx;
worker_processes auto;

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    keepalive_timeout 65;
    gzip on;

    # Upstream configuration for horizontal scaling
    # ğŸš€ ì—¬ëŸ¬ ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¶”ê°€í•˜ì—¬ ë¡œë“œ ë°¸ëŸ°ì‹± êµ¬ì„±
    upstream app_backend {
        # ip_hash: ê°™ì€ í´ë¼ì´ì–¸íŠ¸ IPëŠ” í•­ìƒ ê°™ì€ ì„œë²„ë¡œ ë¼ìš°íŒ… (sticky session)
        # Socket.IO Redis adapterë¥¼ ì‚¬ìš©í•˜ë©´ ip_hash ì—†ì´ë„ ë™ì‘í•˜ì§€ë§Œ,
        # ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ê°™ì€ ì„œë²„ë¡œ ì—°ê²°í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
        ip_hash;

        # ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ ëª©ë¡ (í•„ìš”ì— ë”°ë¼ ì¶”ê°€/ì œê±°)
        server app:3000 max_fails=3 fail_timeout=30s;
        # server app2:3000 max_fails=3 fail_timeout=30s;  # ì¶”ê°€ ì„œë²„ ì˜ˆì‹œ
        # server app3:3000 max_fails=3 fail_timeout=30s;  # ì¶”ê°€ ì„œë²„ ì˜ˆì‹œ

        # keepalive connections to upstream servers
        keepalive 32;
    }

    server {
        listen 80;
        server_name localhost; # Changed for local development

        location / {
            proxy_pass http://app_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_read_timeout 86400;

            # Connection header for keepalive
            proxy_set_header Connection "";
        }

        # WebSocket support for chat with sticky session
        location /socket.io/ {
            proxy_pass http://app_backend/socket.io/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket timeout
            proxy_read_timeout 86400;
            proxy_send_timeout 86400;
        }

    }

    # For production, uncomment the following block and configure SSL certificates.
    # This setup assumes you are using Certbot for SSL certificate management.
    # server {
    #     listen 443 ssl http2;
    #     server_name your_domain.com; # Replace with your actual domain

    #     # SSL Certificate
    #     # ssl_certificate /etc/letsencrypt/live/your_domain.com/fullchain.pem; # Managed by Certbot
    #     # ssl_certificate_key /etc/letsencrypt/live/your_domain.com/privkey.pem; # Managed by Certbot
    #     # include /etc/letsencrypt/options-ssl-nginx.conf; # Recommended SSL settings
    #     # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # Recommended SSL settings

    #     location / {
    #         proxy_pass http://app_backend;
    #         proxy_set_header Host $host;
    #         proxy_set_header X-Real-IP $remote_addr;
    #         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #         proxy_set_header X-Forwarded-Proto $scheme;
    #         proxy_http_version 1.1;
    #         proxy_set_header Upgrade $http_upgrade;
    #         proxy_set_header Connection "upgrade";
    #         proxy_read_timeout 86400;
    #     }

    #     location /socket.io/ {
    #         proxy_pass http://app_backend/socket.io/;
    #         proxy_http_version 1.1;
    #         proxy_set_header Upgrade $http_upgrade;
    #         proxy_set_header Connection "upgrade";
    #         proxy_set_header Host $host;
    #         proxy_cache_bypass $http_upgrade;
    #         proxy_set_header X-Real-IP $remote_addr;
    #         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #         proxy_set_header X-Forwarded-Proto $scheme;
    #         proxy_read_timeout 86400;
    #         proxy_send_timeout 86400;
    #     }
    # }

}
