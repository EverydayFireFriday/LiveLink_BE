<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¬¸ì˜ ìƒì„¸ - ê´€ë¦¬</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 40px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
    }

    .back-button {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .back-button:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .container {
      max-width: 900px;
      margin: 30px auto;
      padding: 0 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      padding: 30px;
      margin-bottom: 20px;
    }

    .inquiry-header {
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 20px;
      margin-bottom: 20px;
    }

    .inquiry-subject {
      font-size: 24px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
    }

    .inquiry-meta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .badge {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 500;
    }

    .badge.status-PENDING {
      background: #fef3c7;
      color: #92400e;
    }

    .badge.status-IN_PROGRESS {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge.status-ANSWERED {
      background: #d1fae5;
      color: #065f46;
    }

    .badge.status-CLOSED {
      background: #e5e7eb;
      color: #374151;
    }

    .badge.priority-HIGH {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge.priority-MEDIUM {
      background: #fef3c7;
      color: #92400e;
    }

    .badge.priority-LOW {
      background: #e5e7eb;
      color: #374151;
    }

    .category-badge {
      background: #ede9fe;
      color: #5b21b6;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 500;
    }

    .inquiry-date {
      color: #666;
      font-size: 14px;
    }

    .inquiry-content {
      line-height: 1.8;
      color: #333;
      white-space: pre-wrap;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .admin-response {
      background: #f0fdf4;
      border-left: 4px solid #10b981;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .response-content {
      line-height: 1.8;
      color: #333;
      white-space: pre-wrap;
      margin-bottom: 10px;
    }

    .response-meta {
      color: #666;
      font-size: 13px;
    }

    .response-form {
      margin-top: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }

    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 150px;
      transition: all 0.3s ease;
    }

    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .button-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .button-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .button-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .button-secondary:hover {
      background: #d1d5db;
    }

    .button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .status-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 20px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .status-controls select {
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .error-message {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .success-message {
      background: #d1fae5;
      color: #065f46;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ“§ ë¬¸ì˜ ìƒì„¸</h1>
    <a href="/support/admin/inquiries" class="back-button">â† ëª©ë¡ìœ¼ë¡œ</a>
  </div>

  <div class="container">
    <div id="content">
      <div class="loading">ë¬¸ì˜ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
  </div>

  <script>
    const inquiryId = window.location.pathname.split('/').pop();

    async function loadInquiry() {
      try {
        const response = await fetch(`/support/${inquiryId}`, {
          credentials: 'include'
        });

        if (response.status === 401 || response.status === 403) {
          alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
          window.location.href = '/support/admin/login';
          return;
        }

        if (!response.ok) {
          throw new Error('Failed to load inquiry');
        }

        const data = await response.json();
        displayInquiry(data.data);
      } catch (error) {
        console.error('Error loading inquiry:', error);
        document.getElementById('content').innerHTML = `
          <div class="card">
            <div class="error-message">ë¬¸ì˜ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>
          </div>
        `;
      }
    }

    function displayInquiry(inquiry) {
      // Debug: ë‹µë³€ ë°ì´í„° ì½˜ì†” í™•ì¸
      console.log('inquiry.adminResponse:', inquiry.adminResponse);
      console.log('inquiry.status:', inquiry.status);

      // ë‹µë³€ì´ ìˆëŠ”ì§€ í™•ì¸ (ë” ì—„ê²©í•œ ì²´í¬)
      const hasResponse = inquiry.adminResponse &&
                         inquiry.adminResponse.content &&
                         inquiry.adminResponse.content.trim().length > 0;

      document.getElementById('content').innerHTML = `
        <div class="card">
          <div class="inquiry-header">
            <div class="inquiry-subject">${escapeHtml(inquiry.subject)}</div>
            <div class="inquiry-meta">
              <span class="badge status-${inquiry.status}">${getStatusText(inquiry.status)}</span>
              <span class="badge priority-${inquiry.priority}">${getPriorityText(inquiry.priority)}</span>
              <span class="category-badge">${getCategoryText(inquiry.category)}</span>
            </div>
            <div class="inquiry-date">ì‘ì„±ì¼: ${new Date(inquiry.createdAt).toLocaleString('ko-KR')}</div>
          </div>

          <div class="section-title">ğŸ“ ë¬¸ì˜ ë‚´ìš©</div>
          <div class="inquiry-content">${escapeHtml(inquiry.content)}</div>

          ${hasResponse ? `
            <div class="section-title">âœ… ê´€ë¦¬ì ë‹µë³€</div>
            <div class="admin-response">
              <div class="response-content">${escapeHtml(inquiry.adminResponse.content)}</div>
              <div class="response-meta">
                ë‹µë³€ì¼: ${new Date(inquiry.adminResponse.respondedAt).toLocaleString('ko-KR')}
              </div>
            </div>
          ` : ''}

          <div class="status-controls">
            <label>ìƒíƒœ ë³€ê²½:</label>
            <select id="statusSelect">
              <option value="PENDING" ${inquiry.status === 'PENDING' ? 'selected' : ''}>ëŒ€ê¸°ì¤‘</option>
              <option value="IN_PROGRESS" ${inquiry.status === 'IN_PROGRESS' ? 'selected' : ''}>ì²˜ë¦¬ì¤‘</option>
              <option value="ANSWERED" ${inquiry.status === 'ANSWERED' ? 'selected' : ''}>ë‹µë³€ì™„ë£Œ</option>
              <option value="CLOSED" ${inquiry.status === 'CLOSED' ? 'selected' : ''}>ì¢…ë£Œ</option>
            </select>

            <label>ìš°ì„ ìˆœìœ„:</label>
            <select id="prioritySelect">
              <option value="LOW" ${inquiry.priority === 'LOW' ? 'selected' : ''}>ë‚®ìŒ</option>
              <option value="MEDIUM" ${inquiry.priority === 'MEDIUM' ? 'selected' : ''}>ë³´í†µ</option>
              <option value="HIGH" ${inquiry.priority === 'HIGH' ? 'selected' : ''}>ë†’ìŒ</option>
            </select>
          </div>
        </div>

        ${!hasResponse ? `
          <div class="card">
            <div class="section-title">ğŸ’¬ ë‹µë³€ ì‘ì„±</div>
            <div id="responseMessage"></div>
            <form id="responseForm" class="response-form">
              <div class="form-group">
                <label for="responseContent">ë‹µë³€ ë‚´ìš©</label>
                <textarea id="responseContent" required placeholder="ê³ ê°ì—ê²Œ ì „ë‹¬í•  ë‹µë³€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
              </div>
              <div class="button-group">
                <button type="submit" class="button button-primary">ë‹µë³€ ì „ì†¡</button>
                <button type="button" class="button button-secondary" id="cancelButton">ì·¨ì†Œ</button>
              </div>
            </form>
          </div>
        ` : ''}
      `;

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      document.getElementById('statusSelect').addEventListener('change', updateStatus);
      document.getElementById('prioritySelect').addEventListener('change', updatePriority);

      if (!hasResponse) {
        setupResponseForm();
        // ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const cancelButton = document.getElementById('cancelButton');
        if (cancelButton) {
          cancelButton.addEventListener('click', () => window.history.back());
        }
      }
    }

    function setupResponseForm() {
      const form = document.getElementById('responseForm');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const content = document.getElementById('responseContent').value;
        const submitButton = form.querySelector('button[type="submit"]');

        submitButton.disabled = true;
        submitButton.textContent = 'ì „ì†¡ ì¤‘...';

        try {
          const response = await fetch(`/support/${inquiryId}/response`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({ content })
          });

          if (response.status === 401 || response.status === 403) {
            alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            window.location.href = '/support/admin/login';
            return;
          }

          const data = await response.json();

          if (response.ok) {
            showMessage('success', 'ë‹µë³€ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            setTimeout(() => {
              loadInquiry();
            }, 1500);
          } else {
            showMessage('error', data.message || 'ë‹µë³€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        } catch (error) {
          console.error('Error sending response:', error);
          showMessage('error', 'ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = 'ë‹µë³€ ì „ì†¡';
        }
      });
    }

    async function updateStatus() {
      const status = document.getElementById('statusSelect').value;

      try {
        const response = await fetch(`/support/${inquiryId}/status`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({ status })
        });

        if (response.status === 401 || response.status === 403) {
          alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
          window.location.href = '/support/admin/login';
          return;
        }

        if (response.ok) {
          showMessage('success', 'ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          throw new Error('Failed to update status');
        }
      } catch (error) {
        console.error('Error updating status:', error);
        showMessage('error', 'ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        loadInquiry();
      }
    }

    async function updatePriority() {
      const priority = document.getElementById('prioritySelect').value;

      try {
        const response = await fetch(`/support/${inquiryId}/priority`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({ priority })
        });

        if (response.status === 401 || response.status === 403) {
          alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
          window.location.href = '/support/admin/login';
          return;
        }

        if (response.ok) {
          showMessage('success', 'ìš°ì„ ìˆœìœ„ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          throw new Error('Failed to update priority');
        }
      } catch (error) {
        console.error('Error updating priority:', error);
        showMessage('error', 'ìš°ì„ ìˆœìœ„ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        loadInquiry();
      }
    }

    function showMessage(type, message) {
      const messageDiv = document.getElementById('responseMessage');
      if (!messageDiv) return;

      const className = type === 'success' ? 'success-message' : 'error-message';
      messageDiv.innerHTML = `<div class="${className}">${message}</div>`;

      setTimeout(() => {
        messageDiv.innerHTML = '';
      }, 5000);
    }

    function getStatusText(status) {
      const statusMap = {
        'PENDING': 'ëŒ€ê¸°ì¤‘',
        'IN_PROGRESS': 'ì²˜ë¦¬ì¤‘',
        'ANSWERED': 'ë‹µë³€ì™„ë£Œ',
        'CLOSED': 'ì¢…ë£Œ'
      };
      return statusMap[status] || status;
    }

    function getPriorityText(priority) {
      const priorityMap = {
        'HIGH': 'ë†’ìŒ',
        'MEDIUM': 'ë³´í†µ',
        'LOW': 'ë‚®ìŒ'
      };
      return priorityMap[priority] || priority;
    }

    function getCategoryText(category) {
      const categoryMap = {
        'TECHNICAL': 'ê¸°ìˆ ',
        'ACCOUNT': 'ê³„ì •',
        'PAYMENT': 'ê²°ì œ',
        'FEATURE_REQUEST': 'ê¸°ëŠ¥ ìš”ì²­',
        'BUG_REPORT': 'ë²„ê·¸ ì‹ ê³ ',
        'OTHER': 'ê¸°íƒ€'
      };
      return categoryMap[category] || category;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ (ê¶Œí•œ ì²´í¬ëŠ” ë¡œê·¸ì¸ì—ì„œë§Œ)
    loadInquiry();
  </script>
</body>
</html>
